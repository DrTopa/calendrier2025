<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üéÑ Jour 0 ‚Äì Pr√©dictions sp√©ciales üéÑ</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      background-color: #ffebcd;
      background-image: url('https://www.transparenttextures.com/patterns/snow.png');
      margin: 0;
      padding: 20px;
    }

    h1 {
      font-size: 2.3em;
      margin-bottom: 10px;
      color: #b71c1c;
      font-family: 'Comic Sans MS', cursive;
      text-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      text-align: center;
    }

    #userStatus {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 1.1em;
      color: #a23636;
    }

    #instructions {
      background: rgba(255, 255, 255, 0.9);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      margin-bottom: 20px;
      text-align: center;
      max-width: 900px;
      font-size: 1.1em;
      color: #333;
    }

    #predictionArea {
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid #b71c1c;
      border-radius: 12px;
      padding: 20px 30px;
      box-shadow: 0 8px 12px rgba(0,0,0,0.12);
      text-align: center;
      width: 100%;
      max-width: 720px;
    }

    select {
      padding: 10px;
      font-size: 1.05em;
      margin: 10px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 80%;
    }

    #submit-btn {
      padding: 10px 20px;
      font-size: 1.05em;
      cursor: pointer;
      background-color: #388e3c;
      color: white;
      border: none;
      border-radius: 5px;
      margin-top: 12px;
    }

    #submit-btn:hover { background-color: #2e7d32; }

    #your-answer { margin-top: 15px; font-weight: bold; font-size: 1.05em; color: #2e7d32; }

    #answersList {
      display: none;
      margin-top: 25px;
      padding: 15px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 4px 6px rgba(0,0,0,0.12);
      max-width: 720px;
      width: 90%;
    }

    #answersList ul { padding-left: 0; margin: 0; }
    #answersList li {
      background: rgba(250,250,250,0.9);
      margin: 8px 0;
      padding: 10px;
      border-radius: 6px;
      border-left: 5px solid #b71c1c;
      list-style: none;
      font-size: 0.98em;
    }

    .small { font-size:0.9em; color:#666 }
    .center { text-align:center }
  </style>
</head>
<body>
  <h1>üéÅ Jour 0 ‚Äì Pr√©dictions Sp√©ciales üéÅ</h1>

  <div id="instructions">
    <p>R√©pondez aux quelques questions ci-dessous ‚Äî vous ne pouvez soumettre qu'une seule fois pour le Jour 0.</p>
    <ul style="text-align:left; display:inline-block;">
      <li>Neige √† Paris en Decembre ?</li>
      <li>Neige au Luxembourg en  Decembre ?</li>
      <li>Squeezie sortira-t-il un nouveau concept de jeu ?</li>
      <li>Nouvelle vid√©o de Choss sur No√´l ?</li>
      <li>Choisis ton entreprise poulain (10 entreprises du CAC40 propos√©es)</li>
      <li>Qui sera le premier √† avoir une carte tr√®s rare ?</li>
    </ul>
  </div>

  <div id="userStatus"></div>

 <div id="predictionArea">

  <label><b>Neigera-t-il √† Paris en D√©cembre ?</b> <span class="small">(3 pts)</span></label><br>
  <select id="neige-paris">
    <option value="">-- Choisissez --</option>
    <option value="oui">Oui</option>
    <option value="non">Non</option>
  </select><br>

  <label><b>Neigera-t-il au Luxembourg en D√©cembre?</b> <span class="small">(3 pts)</span></label><br>
  <select id="neige-lux">
    <option value="">-- Choisissez --</option>
    <option value="oui">Oui</option>
    <option value="non">Non</option>
  </select><br>

  <label><b>Squeezie sortira-t-il un nouveau concept de jeu ?</b></label> <span class="small">(3 pts)</span><br>
  <select id="squeezie">
    <option value="">-- Choisissez --</option>
    <option value="oui">Oui</option>
    <option value="non">Non</option>
  </select><br>

  <label><b>Nouvelle vid√©o de Choss sur No√´l ?</b></label> <span class="small">(5 pts)</span><br>
  <select id="choss">
    <option value="">-- Choisissez --</option>
    <option value="oui">Oui</option>
    <option value="non">Non</option>
  </select><br>

  <label><b>Choisis ton entreprise poulain :</b></label> <span class="small">(√âvolution *5 tous les 5 jours, rien si n√©gatif)</span><br>
  <select id="entreprise">
    <option value="">-- Choisissez --</option>
    <option value="LVMH">LVMH</option>
    <option value="TotalEnergies">TotalEnergies</option>
    <option value="L'Or√©al">L'Or√©al</option>
    <option value="Air Liquide">Air Liquide</option>
    <option value="Sanofi">Sanofi</option>
    <option value="Dassault Syst√®mes">Dassault Syst√®mes</option>
    <option value="BNP Paribas">BNP Paribas</option>
    <option value="AXA">AXA</option>
    <option value="Kering">Kering</option>
    <option value="Schneider Electric">Schneider Electric</option>
  </select><br>

  <label><b>Qui sera le premier √† avoir une carte tr√®s rare ?</b></label> <span class="small">(20 pts)</span><br>
  <select id="niveau6">
    <option value="">-- Choisissez --</option>
    <option value="Adrien">Adrien</option>
    <option value="Nono">Nono</option>
    <option value="Thaddee">Thadd√©e</option>
    <option value="Loris">Loris</option>
    <option value="Romain">Romain</option>
  </select><br>

  <button id="submit-btn">Soumettre mes pr√©dictions</button>
  <div id="your-answer" class="center"></div>
</div>

  <div id="answersList">
    <h3>üìä Pr√©dictions des autres joueurs :</h3>
    <ul id="answers"></ul>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// ---- CONFIG FIREBASE (identique √† l'app principale) ----
const firebaseConfig = {
  apiKey: "AIzaSyDDlMXjm5ibq9FiPOjrBD1HFAIlYRnCzqA",
  authDomain: "calendrier2025-3185f.firebaseapp.com",
  projectId: "calendrier2025-3185f",
  storageBucket: "calendrier2025-3185f.firebasestorage.app",
  messagingSenderId: "846792576145",
  appId: "1:846792576145:web:59028ccef4ffd5c8010330",
  measurementId: "G-L62L4JSYMF"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ---- ELEMENTS ----
const fields = {
  paris: document.getElementById('neige-paris'),
  lux: document.getElementById('neige-lux'),
  squeezie: document.getElementById('squeezie'),
  choss: document.getElementById('choss'),
  entreprise: document.getElementById('entreprise'),
  niveau6: document.getElementById('niveau6')
};
const submitBtn = document.getElementById('submit-btn');
const yourAnswerDiv = document.getElementById('your-answer');
const answersListDiv = document.getElementById('answersList');
const answersUl = document.getElementById('answers');
let currentUser = null;

// ---- AUTH ----
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = 'login.html';
    return;
  }
  currentUser = user;
  document.getElementById('userStatus').innerText = `Connect√© : ${user.email}`;

  // v√©rifier si l'utilisateur a d√©j√† soumis pour Jour 0
  try {
    const jour0Ref = doc(db, 'Predictions', 'Jour 0');
    const jour0Snap = await getDoc(jour0Ref);
    if (jour0Snap.exists() && jour0Snap.data()[user.uid]) {
      showExistingPrediction(jour0Snap.data()[user.uid]);
    } else {
      // charger les r√©ponses des autres m√™me si l'utilisateur n'a pas encore r√©pondu
      loadOtherAnswers();
    }
  } catch (err) {
    console.error('Erreur lecture Firestore:', err);
  }
});

// ---- AFFICHER PR√âDICTIONS EXISTANTES ----
function showExistingPrediction(data) {
  // masquer les champs
  for (const k in fields) fields[k].style.display = 'none';
  submitBtn.style.display = 'none';

  yourAnswerDiv.innerHTML = `\n    ‚úÖ Vos pr√©dictions :\n    <ul style="list-style:none; padding-left:0; margin:0">\n      <li><b>Neige Paris :</b> ${escapeHtml(data.paris)}</li>\n      <li><b>Neige Luxembourg :</b> ${escapeHtml(data.lux)}</li>\n      <li><b>Squeezie :</b> ${escapeHtml(data.squeezie)}</li>\n      <li><b>Choss No√´l :</b> ${escapeHtml(data.choss)}</li>\n      <li><b>Entreprise :</b> ${escapeHtml(data.entreprise)}</li>\n      <li><b>Rare :</b> ${escapeHtml(data.niveau6)}</li>\n    </ul>\n  `;

  answersListDiv.style.display = 'block';
  loadOtherAnswers();
}

// ---- SOUMISSION ----
submitBtn.addEventListener('click', async () => {
  if (!currentUser) { alert('Utilisateur non identifi√©.'); return; }

  const payload = {
    userId: currentUser.uid,
    userEmail: currentUser.email,
    paris: fields.paris.value,
    lux: fields.lux.value,
    squeezie: fields.squeezie.value,
    choss: fields.choss.value,
    entreprise: fields.entreprise.value,
    niveau6: fields.niveau6.value,
    timestamp: new Date().toISOString()
  };

  // validation simple
  if (!payload.paris || !payload.lux || !payload.squeezie || !payload.choss || !payload.entreprise || !payload.niveau6) {
    alert('Merci de r√©pondre √† toutes les questions avant de soumettre.');
    return;
  }

  try {
    const jour0Ref = doc(db, 'Predictions', 'Jour 0');
    const jour0Snap = await getDoc(jour0Ref);

    if (jour0Snap.exists()) {
      const data = jour0Snap.data();
      if (data[currentUser.uid]) {
        alert('Vous avez d√©j√† soumis vos pr√©dictions pour Jour 0.');
        showExistingPrediction(data[currentUser.uid]);
        return;
      }
      // ajouter sous l'UID
      await updateDoc(jour0Ref, { [currentUser.uid]: payload });
    } else {
      // cr√©er le document
      await setDoc(jour0Ref, { [currentUser.uid]: payload });
    }

    // afficher
    showExistingPrediction(payload);
    // succ√®s
    yourAnswerDiv.insertAdjacentHTML('beforeend', '<div class="small">Vos r√©ponses ont √©t√© enregistr√©es.</div>');
  } catch (err) {
    console.error('Erreur lors de la soumission :', err);
    alert('Erreur lors de la soumission, r√©essayez plus tard.');
  }
});

// ---- CHARGER LES AUTRES R√âPONSES ----
async function loadOtherAnswers() {
  answersUl.innerHTML = '';
  try {
    const jour0Ref = doc(db, 'Predictions', 'Jour 0');
    const jour0Snap = await getDoc(jour0Ref);
    if (!jour0Snap.exists()) return;
    const all = jour0Snap.data();
    const entries = Object.entries(all).filter(([uid]) => uid !== (currentUser && currentUser.uid));

    if (entries.length === 0) {
      answersUl.innerHTML = '<li class="small">Aucune autre r√©ponse pour l‚Äôinstant.</li>';
      answersListDiv.style.display = 'block';
      return;
    }

    // afficher les autres (tri√©s par timestamp d√©croissant si possible)
    entries.sort((a,b) => {
      const ta = a[1].timestamp ? Date.parse(a[1].timestamp) : 0;
      const tb = b[1].timestamp ? Date.parse(b[1].timestamp) : 0;
      return tb - ta;
    });

    for (const [uid, data] of entries) {
      const li = document.createElement('li');
      li.innerHTML = `<b>${escapeHtml(data.userEmail || 'Anonyme')}</b> ‚Äî ${escapeHtml(data.paris)} | ${escapeHtml(data.lux)} | Squeezie:${escapeHtml(data.squeezie)} | Choss:${escapeHtml(data.choss)} | ${escapeHtml(data.entreprise)} | Rare:${escapeHtml(data.niveau6)} <div class="small">${escapeHtml(new Date(data.timestamp || '').toLocaleString() || '')}</div>`;
      answersUl.appendChild(li);
    }
    answersListDiv.style.display = 'block';
  } catch (err) {
    console.error('Erreur lecture autres r√©ponses :', err);
    answersUl.innerHTML = '<li class="small">Impossible de charger les autres r√©ponses.</li>';
    answersListDiv.style.display = 'block';
  }
}

// ---- PETITE FONCTION D'√âCHAPPEMENT POUR S√âCURIT√â D'AFFICHAGE ----
function escapeHtml(str) {
  if (str === undefined || str === null) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

</script>
</body>
</html>
