<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Packs</title>
<style>
body {
  font-family: 'Segoe UI', Tahoma, sans-serif;
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  background-color: #ffebcd;
  background-image: url('https://www.transparenttextures.com/patterns/snow.png');
  margin: 0;
  padding: 20px;
}

h1 {
  font-size: 2.5em;
  margin-bottom: 20px;
  color: #d32f2f;
  font-family: 'Comic Sans MS', cursive;
  text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
}

#userStatus {
  font-size: 1.2em;
  margin-bottom: 15px;
  color: #a23636;
  font-weight: bold;
}

#packArea {
  background: rgba(255, 255, 255, 0.8);
  border: 2px solid #b71c1c;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
  margin-top: 20px;
  text-align: center;
}

#buttonsArea {
  margin-top: 15px;
}

button {
  padding: 10px 20px;
  font-size: 1.1em;
  cursor: pointer;
  margin: 5px;
  border-radius: 8px;
  border: none;
  color: white;
}

#openPackBtn { background-color: #388e3c; }
#openPackBtn:hover { background-color: #2e7d32; }

#nextBtn { background-color: #f57c00; }
#nextBtn:hover { background-color: #e65100; }

#cardsResult {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-top: 20px;
  flex-wrap: wrap;
  perspective: 1000px;
}
/* Halo visible uniquement apr√®s r√©v√©lation */
.card[data-rarity="uncommon"].flipped {
  box-shadow: 0 0 20px 4px rgba(0, 150, 255, 0.7);
}

.card[data-rarity="rare"].flipped {
  animation: goldenGlow 2s infinite alternate;
  box-shadow: 0 0 25px 6px rgba(255, 215, 0, 0.8);
}

@keyframes goldenGlow {
  0% { box-shadow: 0 0 15px 4px rgba(255, 215, 0, 0.6); }
  100% { box-shadow: 0 0 35px 10px rgba(255, 215, 0, 1); }
}

/* Badge ‚ÄúNouvelle !‚Äù */
.new-badge {
  position: absolute;
  top: 8px;
  left: 8px;
  background: linear-gradient(45deg, #ff6b6b, #ffb84d);
  color: white;
  font-weight: bold;
  font-size: 0.9em;
  padding: 5px 8px;
  border-radius: 6px;
  box-shadow: 0 0 8px rgba(0,0,0,0.3);
  transform: rotate(-5deg);
  opacity: 0;
  transition: opacity 0.5s;
}

.card.flipped .new-badge {
  opacity: 1;
}

.card {
  width: 140px;
  height: 200px;
  border-radius: 10px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  background: #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  transform-style: preserve-3d;
  transition: transform 0.6s;
  position: relative;
}

.card.flipped { transform: rotateY(180deg); }

.card .front, .card .back {
  position: absolute;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
  border-radius: 10px;
}

.card .front { transform: rotateY(180deg); }

.card img { width: 100%; height: 100%; border-radius: 10px; }

#message {
  margin-top: 15px;
  font-size: 1.2em;
  color: #b71c1c;
}
</style>
</head>
<body>
<h1>üéÑ Ouverture Paquets üéÑ</h1>
<div id="userStatus">Chargement...</div>

<div id="packArea">
  <div id="buttonsArea">
    <button id="openPackBtn">üéÅ Ouvrir un paquet (5 jetons)</button>
    <button id="nextBtn">Suivant</button>
  </div>
  <div id="message"></div>
  <div id="cardsResult"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDDlMXjm5ibq9FiPOjrBD1HFAIlYRnCzqA",
  authDomain: "calendrier2025-3185f.firebaseapp.com",
  projectId: "calendrier2025-3185f",
  storageBucket: "calendrier2025-3185f.firebasestorage.app",
  messagingSenderId: "846792576145",
  appId: "1:846792576145:web:59028ccef4ffd5c8010330",
  measurementId: "G-L62L4JSYMF"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// dictionnaire complet des 92 images (inchang√©)
const pictureLinks = {
  1: "https://i.imgur.com/ewqwwd3.png",
  2: "https://i.imgur.com/MiUjcra.png",
  3: "https://i.imgur.com/gtAzNLQ.png",
  4: "https://i.imgur.com/HGmmFRo.png",
  5: "https://i.imgur.com/ihhHq2q.png",
  6: "https://i.imgur.com/kurR7Fg.png",
  7: "https://i.imgur.com/CruwG9r.png",
  8: "https://i.imgur.com/SOVLwmr.png",
  9: "https://i.imgur.com/i0hCSeW.png",
  10: "https://i.imgur.com/A8xouVf.png",
  11: "https://i.imgur.com/BDCQ2kM.png",
  12: "https://i.imgur.com/Ppdjtu6.png",
  13: "https://i.imgur.com/w47g1xe.png",
  14: "https://i.imgur.com/Vimn4hL.png",
  15: "https://i.imgur.com/ZgLeo3r.png",
  16: "https://i.imgur.com/4HwEdtu.png",
  17: "https://i.imgur.com/QrjAXaO.png",
  18: "https://i.imgur.com/3UQctnY.png",
  19: "https://i.imgur.com/GgxbxSR.png",
  20: "https://i.imgur.com/6qc7FPn.png",
  21: "https://i.imgur.com/hylK7Oe.png",
  22: "https://i.imgur.com/yJFcl3Z.png",
  23: "https://i.imgur.com/ZBur6N5.png",
  24: "https://i.imgur.com/mI6ix2S.png",
  25: "https://i.imgur.com/wR2CIoG.png",
  26: "https://i.imgur.com/55Kw0Nl.png",
  27: "https://i.imgur.com/wxbAOzj.png",
  28: "https://i.imgur.com/behZzHj.png",
  29: "https://i.imgur.com/KgvWBEL.png",
  30: "https://i.imgur.com/U8CjA75.png",
  31: "https://i.imgur.com/1L1qN3E.png",
  32: "https://i.imgur.com/8UzGnPn.png",
  33: "https://i.imgur.com/XkSp2h8.png",
  34: "https://i.imgur.com/GvJpwqW.png",
  35: "https://i.imgur.com/zMdItr2.png",
  36: "https://i.imgur.com/HKOS9R3.png",
  37: "https://i.imgur.com/UXBVHeZ.png",
  38: "https://i.imgur.com/apINuyT.png",
  39: "https://i.imgur.com/8yvWgVw.png",
  40: "https://i.imgur.com/qqnSfZF.png",
  41: "https://i.imgur.com/FvuN276.png",
  42: "https://i.imgur.com/Ye5uyiE.png",
  43: "https://i.imgur.com/g50GLoG.png",
  44: "https://i.imgur.com/uIfvKVG.png",
  45: "https://i.imgur.com/9zLEKsk.png",
  46: "https://i.imgur.com/V0XuA2I.png",
  47: "https://i.imgur.com/G7tVea1.png",
  48: "https://i.imgur.com/zhMkGHm.png",
  49: "https://i.imgur.com/QcHQzy8.png",
  50: "https://i.imgur.com/g88RqCc.png",
  51: "https://i.imgur.com/46cx2gP.png",
  52: "https://i.imgur.com/h3ZbyhC.png",
  53: "https://i.imgur.com/lcYg9w1.png",
  54: "https://i.imgur.com/0dXsNyO.png",
  55: "https://i.imgur.com/3AJToac.png",
  56: "https://i.imgur.com/mL5WQyW.png",
  57: "https://i.imgur.com/KUOYPn7.png",
  58: "https://i.imgur.com/bIUpa5z.png",
  59: "https://i.imgur.com/y7dqXOr.png",
  60: "https://i.imgur.com/qYXH9ic.png",
  61: "https://i.imgur.com/mcs0iV6.png",
  62: "https://i.imgur.com/xDuaNuC.png",
  63: "https://i.imgur.com/tz1oaE6.png",
  64: "https://i.imgur.com/nPuwu22.png",
  65: "https://i.imgur.com/ezMbxnf.png",
  66: "https://i.imgur.com/ulcpx9p.png",
  67: "https://i.imgur.com/EsOGQlC.png",
  68: "https://i.imgur.com/l8jwwRa.png",
  69: "https://i.imgur.com/WrxnlKe.png",
  70: "https://i.imgur.com/TBHpA6n.png",
  71: "https://i.imgur.com/TwRXNCp.png",
  72: "https://i.imgur.com/QxbGzRC.png",
  73: "https://i.imgur.com/DCqpBot.png",
  74: "https://i.imgur.com/VNV9grK.png",
  75: "https://i.imgur.com/tlMwUmg.png",
  76: "https://i.imgur.com/SmysCbX.png",
  77: "https://i.imgur.com/Wvt21zL.png",
  78: "https://i.imgur.com/12s1WaQ.png",
  79: "https://i.imgur.com/jfrVisV.png",
  80: "https://i.imgur.com/FCpnXVM.png",
  81: "https://i.imgur.com/3unY1WO.png",
  82: "https://i.imgur.com/eCfS1rL.png",
  83: "https://i.imgur.com/Zsfc0OW.png",
  84: "https://i.imgur.com/XUUsW7t.png",
  85: "https://i.imgur.com/Z0KsIJS.png",
  86: "https://i.imgur.com/vAvKqW5.png",
  87: "https://i.imgur.com/0oBYzEs.png",
  88: "https://i.imgur.com/7oN3Ivg.png",
  89: "https://i.imgur.com/HcQgtUu.png",
  90: "https://i.imgur.com/Yz1yYqt.png",
  91: "https://i.imgur.com/bh3wUgz.png",
  92: "https://i.imgur.com/EMo7O1h.png",
};

const cardBack = "https://i.imgur.com/kgI2UCT.png";

const commons = [10,13,14,16,17,19,2,20,23,25,26,3,30,32,40,41,42,44,45,47,5,50,51,53,55,56,57,58,59,6,60,61,62,65,66,67,68,7,70,71,73,74,75,76,77,79,8,80,81,82,84,86,88,9,90,91,92];
const uncommons = [1,11,12,15,18,21,22,24,28,29,33,34,4,43,46,48,49,52,54,63,64,69,72,78,83,85,87,89];
const rares = [27,31,35,36,37,38,39];

// === Utilitaires ===
function getRarity(num) {
  if (rares.includes(num)) return "rare";
  if (uncommons.includes(num)) return "uncommon";
  return "common";
}

function drawCard(isSeventh = false) {
  if (isSeventh) {
    const r = Math.random();
    if (r < 0.05) return rares[Math.floor(Math.random() * rares.length)];
    return uncommons[Math.floor(Math.random() * uncommons.length)];
  }

  const r = Math.random();
  if (r < 0.73) return commons[Math.floor(Math.random() * commons.length)];
  else if (r < 0.73 + 0.207) return uncommons[Math.floor(Math.random() * uncommons.length)];
  else return rares[Math.floor(Math.random() * rares.length)];
}

let currentUser = null;

onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    const userRef = doc(db, "users", user.uid);
    const userSnap = await getDoc(userRef);
    if (userSnap.exists()) {
      const data = userSnap.data();
      document.getElementById("userStatus").innerText =
        `Connect√© : ${data.email} ‚Äî Jetons : ${data.jetons ?? 0}`;
    }
  } else {
    document.getElementById("userStatus").innerText = "Non connect√©";
    currentUser = null;
  }
});

// === Cr√©ation d'une carte ===
function createCard(num, rarity, isNew) {
  const card = document.createElement("div");
  card.classList.add("card");
  card.dataset.rarity = rarity;

  const front = document.createElement("div");
  front.classList.add("front");
  const imgFront = document.createElement("img");
  imgFront.src = pictureLinks[num];
  front.appendChild(imgFront);

  if (isNew) {
    const badge = document.createElement("div");
    badge.classList.add("new-badge");
    badge.innerText = "üÜï Nouvelle !";
    front.appendChild(badge);
  }

  const back = document.createElement("div");
  back.classList.add("back");
  const imgBack = document.createElement("img");
  imgBack.src = cardBack;
  back.appendChild(imgBack);

  card.appendChild(front);
  card.appendChild(back);

  card.addEventListener("click", () => {
    card.classList.toggle("flipped");
  });

  return card;
}

// === Ouverture d‚Äôun pack ===
document.getElementById("openPackBtn").addEventListener("click", async () => {
  if (!currentUser) {
    document.getElementById("message").innerText = "Vous devez √™tre connect√©.";
    return;
  }

  const userRef = doc(db, "users", currentUser.uid);
  const userSnap = await getDoc(userRef);
  if (!userSnap.exists()) {
    document.getElementById("message").innerText = "Profil introuvable.";
    return;
  }

  const data = userSnap.data();
  let tokens = data.jetons ?? 0;
  if (tokens < 5) {
    document.getElementById("message").innerText = `Pas assez de jetons (${tokens})`;
    return;
  }

  tokens -= 5;

  const obtainedCards = [];
  const newFlags = {}; // pour savoir quelles cartes sont nouvelles
  for (let i = 0; i < 6; i++) obtainedCards.push(drawCard(false));
  obtainedCards.push(drawCard(true));

  for (const num of obtainedCards) {
    const key = `Picture${num}`;
    newFlags[num] = !data[key]; // vrai si carte nouvelle
    data[key] = true; // on la marque comme obtenue
  }

  await updateDoc(userRef, {
    jetons: tokens,
    ...obtainedCards.reduce((acc, num) => ({ ...acc, [`Picture${num}`]: true }), {})
  });

  document.getElementById("userStatus").innerText =
    `Connect√© : ${data.email} ‚Äî Jetons : ${tokens}`;

  const resultDiv = document.getElementById("cardsResult");
  resultDiv.innerHTML = "";
  obtainedCards.forEach(num => {
    const rarity = getRarity(num);
    const cardDiv = createCard(num, rarity, newFlags[num]);
    resultDiv.appendChild(cardDiv);
  });

  document.getElementById("message").innerText =
    "Cliquez sur chaque carte pour la r√©v√©ler.";
});

// === Bouton suivant ===
document.getElementById("nextBtn").addEventListener("click", () => {
  const resultDiv = document.getElementById("cardsResult");
  resultDiv.style.justifyContent = "flex-start";
  resultDiv.style.flexWrap = "nowrap";
  resultDiv.querySelectorAll(".card").forEach(c => c.classList.add("flipped"));
  document.getElementById("message").innerText = "R√©sum√© du tirage.";
});
</script>
</body>
</html>
