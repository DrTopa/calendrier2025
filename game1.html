<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üìä Jour 1 ‚Äì √âlections Sainte-Lucie & France‚ÄìSu√®de</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      flex-direction: column;
      background-color: #ffebcd;
      background-image: url('https://www.transparenttextures.com/patterns/snow.png');
      margin: 0;
      padding: 24px;
      gap: 18px;
    }

    h1 {
      font-size: 2.1em;
      color: #b71c1c;
      font-family: 'Comic Sans MS', cursive;
      text-shadow: 2px 2px 5px rgba(0,0,0,0.25);
      text-align: center;
      margin: 0 0 8px 0;
    }

    .container {
      max-width: 920px;
      margin: 0 auto;
      width: 100%;
    }

    #userStatus {
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 1.0em;
      color: #a23636;
    }

    .panel {
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 6px 14px rgba(0,0,0,0.12);
      border: 2px solid rgba(183,28,28,0.08);
      margin-bottom: 18px;
    }

    .panel h2 {
      margin-top: 0;
      color: #b71c1c;
      font-size: 1.25em;
    }

    label { display:block; margin-top:8px; }
    select, input {
      padding: 10px;
      font-size: 1.02em;
      margin-top:6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 100%;
      box-sizing: border-box;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items: start;
    }

    .small { font-size:0.9em; color:#666; margin-left:6px; }
    .muted { color:#555; font-size:0.95em; }

    #submit-btn {
      padding: 12px 20px;
      font-size: 1.05em;
      cursor: pointer;
      background-color: #388e3c;
      color: white;
      border: none;
      border-radius: 6px;
      margin-top: 12px;
    }
    #submit-btn:hover { background-color: #2e7d32; }

    #your-answer { margin-top: 12px; font-weight: bold; font-size: 1.02em; color: #2e7d32; }

    #answersList {
      display: none;
      margin-top: 18px;
      padding: 12px;
      border-radius: 8px;
      background: rgba(255,255,255,0.98);
      box-shadow: 0 4px 8px rgba(0,0,0,0.06);
      max-width: 920px;
      margin-left: auto;
      margin-right: auto;
    }

    #answersList ul { padding-left: 0; margin: 0; list-style: none; }
    #answersList li {
      background: rgba(250,250,250,0.95);
      margin: 8px 0;
      padding: 10px;
      border-radius: 6px;
      border-left: 5px solid #b71c1c;
      font-size: 0.98em;
    }

    .meta { font-size:0.85em; color:#777; margin-top:6px; }
    .divider { height:1px; background:#eee; margin:12px 0; border-radius:2px; }
  </style>
</head>
<body>
  <div id="userStatus"></div>

  <div class="container">
    <h1>üìä Jour 1 ‚Äì √âlections Sainte-Lucie 2025 & Match France üá´üá∑ vs Su√®de üá∏üá™</h1>

    <!-- PANEL ELECTIONS -->
    <div class="panel" id="elections-panel">
      <h2>√âlections ‚Äî Sainte-Lucie 2025</h2>
      <div class="muted">Indications de points : <span class="small">Majorit√© = 3 pts | Si√®ges = 10 pts si exact, -1 par √©cart | Participation = 20 pts si exacte, -1 par √©cart | Stephenson = 3 pts | Philip = 3 pts</span></div>

      <label><b>Quelle partie aura la majorit√© ?</b> <span class="small">(Bonne r√©ponse = 3 pts)</span></label>
      <select id="majorityParty">
        <option value="">-- Choisissez --</option>
        <option value="parti_travailliste">Parti Travailliste</option>
        <option value="parti_uni">Parti Uni des Travailleurs</option>
      </select>

      <div class="row">
        <div>
          <label><b>Combien de si√®ges pour la majorit√© ?</b> <span class="small">(10 pts si exact, -1 pt par √©cart)</span></label>
          <input id="majoritySeats" type="number" min="0" max="15" placeholder="0-15">
        </div>
        <div>
          <label><b>Participation (%) :</b> <span class="small">(20 pts si exacte, -1 pt par √©cart)</span></label>
          <input id="participation" type="number" min="0" max="100" placeholder="ex : 72">
        </div>
      </div>

      <div class="row">
        <div>
          <label><b>Stephenson King r√©√©lu ?</b> <span class="small">(3 pts)</span></label>
          <select id="stephenson">
            <option value="">-- Choisissez --</option>
            <option value="oui">Oui</option>
            <option value="non">Non</option>
          </select>
        </div>
        <div>
          <label><b>Philip Pierre r√©√©lu ?</b> <span class="small">(3 pts)</span></label>
          <select id="philip">
            <option value="">-- Choisissez --</option>
            <option value="oui">Oui</option>
            <option value="non">Non</option>
          </select>
        </div>
      </div>
    </div>

    <!-- PANEL FOOTBALL -->
    <div class="panel" id="football-panel">
      <h2>Match ‚Äî France vs Su√®de (pronostics football)</h2>
      <div class="muted">Indications de points : <span class="small">R√©sultat = 5 pts | Score exact = 20 pts | Cartons jaunes = 20 pts (p√©nalit√© -5 pts par erreur) | Cartons rouges = 10 pts</span></div>

      <label><b>R√©sultat du match :</b> <span class="small">(5 pts)</span></label>
      <select id="result-select">
        <option value="">-- Choisissez --</option>
        <option value="france">Victoire France</option>
        <option value="nul">Nul</option>
        <option value="suede">Victoire Su√®de</option>
      </select>

      <label><b>Score final :</b> <span class="small">(20 pts)</span></label>
      <input id="score-input" type="text" placeholder="ex : 2-1">

      <div class="row">
        <div>
          <label><b>Cartons jaunes :</b> <span class="small">(20 pts, -5 pts par erreur)</span></label>
          <input id="yellow-input" type="number" min="0" placeholder="ex : 3">
        </div>
        <div>
          <label><b>Cartons rouges :</b> <span class="small">(10 pts)</span></label>
          <input id="red-input" type="number" min="0" placeholder="ex : 1">
        </div>
      </div>
    </div>

    <div style="text-align:center; margin-top:6px;">
      <button id="submit-btn">Soumettre mes pr√©dictions (√âlections + Football)</button>
      <div id="your-answer"></div>
    </div>

    <div id="answersList">
      <h3>üìä Pr√©dictions des autres joueurs :</h3>
      <ul id="answers"></ul>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// Firebase config (identique √† l'app)
const firebaseConfig = {
  apiKey: "AIzaSyDDlMXjm5ibq9FiPOjrBD1HFAIlYRnCzqA",
  authDomain: "calendrier2025-3185f.firebaseapp.com",
  projectId: "calendrier2025-3185f",
  storageBucket: "calendrier2025-3185f.firebasestorage.app",
  messagingSenderId: "846792576145",
  appId: "1:846792576145:web:59028ccef4ffd5c8010330",
  measurementId: "G-L62L4JSYMF"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// elements
const fields = {
  majorityParty: document.getElementById('majorityParty'),
  majoritySeats: document.getElementById('majoritySeats'),
  participation: document.getElementById('participation'),
  stephenson: document.getElementById('stephenson'),
  philip: document.getElementById('philip'),
  result: document.getElementById('result-select'),
  score: document.getElementById('score-input'),
  yellow: document.getElementById('yellow-input'),
  red: document.getElementById('red-input')
};

const submitBtn = document.getElementById('submit-btn');
const yourAnswerDiv = document.getElementById('your-answer');
const answersListDiv = document.getElementById('answersList');
const answersUl = document.getElementById('answers');
let currentUser = null;

// Auth listener
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = 'login.html';
    return;
  }
  currentUser = user;
  document.getElementById('userStatus').innerText = `Connect√© : ${user.email}`;

  try {
    const jour1Ref = doc(db, 'Predictions', 'Jour 1');
    const jour1Snap = await getDoc(jour1Ref);
    if (jour1Snap.exists() && jour1Snap.data()[user.uid]) {
      // l'utilisateur a d√©j√† soumis ‚Äî afficher
      showExistingPrediction(jour1Snap.data()[user.uid]);
    } else {
      // charger les autres r√©ponses pour information
      loadOtherAnswers();
    }
  } catch (err) {
    console.error('Erreur lecture Firestore:', err);
  }
});

// afficher pr√©diction d√©j√† soumise
function showExistingPrediction(data) {
  // masquer tous les champs
  for (const k in fields) {
    if (fields[k]) fields[k].style.display = 'none';
  }
  submitBtn.style.display = 'none';

  // Affichage synth√©tique (√©lections + football)
  yourAnswerDiv.innerHTML = `
    ‚úÖ Vos pr√©dictions ont √©t√© enregistr√©es :
    <div style="text-align:left; margin:8px 20px;">
      <strong>√âlections ‚Äî Sainte-Lucie</strong>
      <ul style="margin:6px 0 10px 18px; padding:0;">
        <li>Majorit√© : ${escapeHtml(data.majorityParty)}</li>
        <li>Si√®ges : ${escapeHtml(String(data.majoritySeats))}</li>
        <li>Participation : ${escapeHtml(String(data.participation))}%</li>
        <li>Stephenson King : ${escapeHtml(data.stephenson)}</li>
        <li>Philip Pierre : ${escapeHtml(data.philip)}</li>
      </ul>
      <strong>Football ‚Äî France vs Su√®de</strong>
      <ul style="margin:6px 0 0 18px; padding:0;">
        <li>R√©sultat : ${escapeHtml(data.result)}</li>
        <li>Score : ${escapeHtml(data.score)}</li>
        <li>Cartons jaunes : ${escapeHtml(String(data.yellow))}</li>
        <li>Cartons rouges : ${escapeHtml(String(data.red))}</li>
      </ul>
      <div class="meta">Soumis le : ${escapeHtml(new Date(data.timestamp || '').toLocaleString() || '')}</div>
    </div>
  `;
  answersListDiv.style.display = 'block';
  loadOtherAnswers();
}

// soumission unique : on enregistre un objet complet sous Predictions/Jour 1 / <uid>
submitBtn.addEventListener('click', async () => {
  if (!currentUser) { alert('Utilisateur non identifi√©.'); return; }

  // lire et valider
  const payload = {
    userId: currentUser.uid,
    userEmail: currentUser.email,
    // √âlections
    majorityParty: fields.majorityParty.value,
    majoritySeats: parseInt(fields.majoritySeats.value, 10),
    participation: parseInt(fields.participation.value, 10),
    stephenson: fields.stephenson.value,
    philip: fields.philip.value,
    // Football
    result: fields.result.value,
    score: fields.score.value.trim(),
    yellow: fields.yellow.value === '' ? null : parseInt(fields.yellow.value, 10),
    red: fields.red.value === '' ? null : parseInt(fields.red.value, 10),
    timestamp: new Date().toISOString()
  };

  // validation basique
  if (!payload.majorityParty || isNaN(payload.majoritySeats) || isNaN(payload.participation)
      || !payload.stephenson || !payload.philip
      || !payload.result || !payload.score || payload.yellow === null || payload.red === null) {
    alert('Merci de remplir correctement tous les champs (√âlections + Football).');
    return;
  }

  try {
    const jour1Ref = doc(db, 'Predictions', 'Jour 1');
    const jour1Snap = await getDoc(jour1Ref);

    if (jour1Snap.exists()) {
      const data = jour1Snap.data();
      if (data[currentUser.uid]) {
        alert('Vous avez d√©j√† soumis vos pr√©dictions pour Jour 1.');
        showExistingPrediction(data[currentUser.uid]);
        return;
      }
      // ajoute sous l'UID dans le document Jour 1
      await updateDoc(jour1Ref, { [currentUser.uid]: payload });
    } else {
      // cr√©er le document Jour 1 et initialiser avec cet UID
      await setDoc(jour1Ref, { [currentUser.uid]: payload });
    }

    // afficher confirmation
    showExistingPrediction(payload);
    yourAnswerDiv.insertAdjacentHTML('beforeend', '<div class="small">Vos r√©ponses ont √©t√© enregistr√©es.</div>');
  } catch (err) {
    console.error('Erreur lors de la soumission :', err);
    alert('Erreur lors de la soumission, r√©essayez plus tard.');
  }
});

// charger et afficher les r√©ponses des autres joueurs (exclut currentUser)
async function loadOtherAnswers() {
  answersUl.innerHTML = '';
  try {
    const jour1Ref = doc(db, 'Predictions', 'Jour 1');
    const jour1Snap = await getDoc(jour1Ref);
    if (!jour1Snap.exists()) {
      answersUl.innerHTML = '<li class="small">Aucune r√©ponse pour l‚Äôinstant.</li>';
      answersListDiv.style.display = 'block';
      return;
    }
    const all = jour1Snap.data();
    const entries = Object.entries(all).filter(([uid]) => uid !== (currentUser && currentUser.uid));

    if (entries.length === 0) {
      answersUl.innerHTML = '<li class="small">Aucune autre r√©ponse pour l‚Äôinstant.</li>';
      answersListDiv.style.display = 'block';
      return;
    }

    // trier par timestamp descendant si disponible
    entries.sort((a,b) => {
      const ta = a[1].timestamp ? Date.parse(a[1].timestamp) : 0;
      const tb = b[1].timestamp ? Date.parse(b[1].timestamp) : 0;
      return tb - ta;
    });

    for (const [uid, data] of entries) {
      const li = document.createElement('li');
      li.innerHTML = `
        <strong>${escapeHtml(data.userEmail || 'Anonyme')}</strong> ‚Äî
        <div style="margin-top:6px;">
          <em>√âlections</em> : ${escapeHtml(data.majorityParty || '')} | Si√®ges: ${escapeHtml(String(data.majoritySeats || ''))} | Participation: ${escapeHtml(String(data.participation || ''))}% | Stephenson: ${escapeHtml(data.stephenson || '')} | Philip: ${escapeHtml(data.philip || '')}
        </div>
        <div style="margin-top:6px;">
          <em>Football</em> : ${escapeHtml(data.result || '')} | Score: ${escapeHtml(data.score || '')} | üü® ${escapeHtml(String(data.yellow || ''))} | üü• ${escapeHtml(String(data.red || ''))}
        </div>
        <div class="meta">${escapeHtml(new Date(data.timestamp || '').toLocaleString() || '')}</div>
      `;
      answersUl.appendChild(li);
    }
    answersListDiv.style.display = 'block';
  } catch (err) {
    console.error('Erreur lecture autres r√©ponses :', err);
    answersUl.innerHTML = '<li class="small">Impossible de charger les autres r√©ponses.</li>';
    answersListDiv.style.display = 'block';
  }
}

// fonction d'√©chappement pour pr√©vention XSS √† l'affichage
function escapeHtml(str) {
  if (str === undefined || str === null) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}
</script>
</body>
</html>
