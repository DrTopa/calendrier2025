<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üèÜ Champions League ‚Äì Jour 8</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background-color: #fdf6e3;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      font-size: 2em;
      text-align: center;
      color: #b71c1c;
      margin-bottom: 10px;
      font-family: 'Comic Sans MS', cursive;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    }

    #instructions {
      background: rgba(255,255,255,0.9);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      max-width: 900px;
      margin-bottom: 20px;
      font-size: 1.05em;
      text-align: center;
    }

    #pointsInfo {
      font-size: 0.9em;
      color: #555;
      margin-top: 5px;
    }

    #predictionArea {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      max-width: 900px;
      width: 100%;
    }

    .match-card {
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 6px 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: transform 0.2s;
    }

    .match-card:hover {
      transform: translateY(-3px);
    }

    .match-title {
      font-weight: bold;
      margin-bottom: 10px;
      text-align: center;
    }

    select, input[type="text"] {
      padding: 8px;
      font-size: 1em;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 90%;
      margin-bottom: 8px;
    }

    .vote-section {
      width: 100%;
      text-align: center;
    }

    .vote-section label {
      margin-right: 8px;
    }

    #submit-btn {
      padding: 10px 20px;
      font-size: 1.1em;
      cursor: pointer;
      background-color: #388e3c;
      color: white;
      border: none;
      border-radius: 6px;
      margin-top: 20px;
      grid-column: span 2;
    }

    #submit-btn:hover { background-color: #2e7d32; }

    #your-answer {
      margin-top: 15px;
      font-weight: bold;
      font-size: 1.05em;
      color: #2e7d32;
      grid-column: span 2;
    }

    #answersList {
      display: none;
      margin-top: 25px;
      padding: 15px;
      border-radius: 10px;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 4px 6px rgba(0,0,0,0.12);
      max-width: 900px;
      width: 100%;
      grid-column: span 2;
    }

    #answersList ul { padding-left: 0; margin: 0; }
    #answersList li {
      background: rgba(250,250,250,0.9);
      margin: 8px 0;
      padding: 8px;
      border-radius: 6px;
      border-left: 5px solid #b71c1c;
      list-style: none;
      font-size: 0.95em;
    }

  </style>
</head>
<body>

<h1>üèÜ Champions League ‚Äì Jour 8</h1>

<div id="instructions">
  <p>Choisissez les matchs pour lesquels vous souhaitez parier. Pour chaque match :</p>
  <ul style="text-align:left; display:inline-block;">
    <li>Voulez-vous voter ? (Oui/Non)</li>
    <li>Si Oui : victoire √©quipe 1 / victoire √©quipe 2 / Nul</li>
  </ul>
  <div id="pointsInfo">
    Points : 1 bonne r√©ponse = 3 pts, 2 = 7 pts, 3 = 12, 4 = 18, 5 = 25, 6 = 33, 7 = 42, 8 = 52, 9 = 63 <br>
    1 r√©ponse fausse = 0 point
  </div>
</div>

<div id="predictionArea">

  <div class="match-card">
    <div class="match-title">Kairat - Olympiakos</div>
    <div class="vote-section">
      <label>Voter ?</label>
      <select class="vote-select">
        <option value="">--Choisissez--</option>
        <option value="oui">Oui</option>
        <option value="non">Non</option>
      </select><br>
      <select class="match-result" style="display:none;">
        <option value="">--R√©sultat--</option>
        <option value="equipe1">Victoire Kairat</option>
        <option value="nul">Nul</option>
        <option value="equipe2">Victoire Olympiakos</option>
      </select>
    </div>
  </div>

  <div class="match-card">
    <div class="match-title">Bayern - Sporting</div>
    <div class="vote-section">
      <label>Voter ?</label>
      <select class="vote-select">
        <option value="">--Choisissez--</option>
        <option value="oui">Oui</option>
        <option value="non">Non</option>
      </select><br>
      <select class="match-result" style="display:none;">
        <option value="">--R√©sultat--</option>
        <option value="equipe1">Victoire Bayern</option>
        <option value="nul">Nul</option>
        <option value="equipe2">Victoire Sporting</option>
      </select>
    </div>
  </div>

  <div class="match-card">
    <div class="match-title">Atlanta - Chelsea</div>
    <div class="vote-section">
      <label>Voter ?</label>
      <select class="vote-select">
        <option value="">--Choisissez--</option>
        <option value="oui">Oui</option>
        <option value="non">Non</option>
      </select><br>
      <select class="match-result" style="display:none;">
        <option value="">--R√©sultat--</option>
        <option value="equipe1">Victoire Atlanta</option>
        <option value="nul">Nul</option>
        <option value="equipe2">Victoire Chelsea</option>
      </select>
    </div>
  </div>

  <div class="match-card">
    <div class="match-title">Monaco - Galatasaray</div>
    <div class="vote-section">
      <label>Voter ?</label>
      <select class="vote-select">
        <option value="">--Choisissez--</option>
        <option value="oui">Oui</option>
        <option value="non">Non</option>
      </select><br>
      <select class="match-result" style="display:none;">
        <option value="">--R√©sultat--</option>
        <option value="equipe1">Victoire Monaco</option>
        <option value="nul">Nul</option>
        <option value="equipe2">Victoire Galatasaray</option>
      </select>
    </div>
  </div>

  <div class="match-card">
    <div class="match-title">Union Saint-Gilloise - OM</div>
    <div class="vote-section">
      <label>Voter ?</label>
      <select class="vote-select">
        <option value="">--Choisissez--</option>
        <option value="oui">Oui</option>
        <option value="non">Non</option>
      </select><br>
      <select class="match-result" style="display:none;">
        <option value="">--R√©sultat--</option>
        <option value="equipe1">Victoire Union Saint-Gilloise</option>
        <option value="nul">Nul</option>
        <option value="equipe2">Victoire OM</option>
      </select>
    </div>
  </div>

  <div class="match-card">
    <div class="match-title">PSV Eindhoven - Atletico Madrid</div>
    <div class="vote-section">
      <label>Voter ?</label>
      <select class="vote-select">
        <option value="">--Choisissez--</option>
        <option value="oui">Oui</option>
        <option value="non">Non</option>
      </select><br>
      <select class="match-result" style="display:none;">
        <option value="">--R√©sultat--</option>
        <option value="equipe1">Victoire PSV</option>
        <option value="nul">Nul</option>
        <option value="equipe2">Victoire Atletico Madrid</option>
      </select>
    </div>
  </div>

  <div class="match-card">
    <div class="match-title">Bar√ßa - Eintract Francfort</div>
    <div class="vote-section">
      <label>Voter ?</label>
      <select class="vote-select">
        <option value="">--Choisissez--</option>
        <option value="oui">Oui</option>
        <option value="non">Non</option>
      </select><br>
      <select class="match-result" style="display:none;">
        <option value="">--R√©sultat--</option>
        <option value="equipe1">Victoire Bar√ßa</option>
        <option value="nul">Nul</option>
        <option value="equipe2">Victoire Eintract Francfort</option>
      </select>
    </div>
  </div>

  <div class="match-card">
    <div class="match-title">Inter - Liverpool</div>
    <div class="vote-section">
      <label>Voter ?</label>
      <select class="vote-select">
        <option value="">--Choisissez--</option>
        <option value="oui">Oui</option>
        <option value="non">Non</option>
      </select><br>
      <select class="match-result" style="display:none;">
        <option value="">--R√©sultat--</option>
        <option value="equipe1">Victoire Inter</option>
        <option value="nul">Nul</option>
        <option value="equipe2">Victoire Liverpool</option>
      </select>
    </div>
  </div>

  <div class="match-card">
    <div class="match-title">Tottenham - Slavia Prague</div>
    <div class="vote-section">
      <label>Voter ?</label>
      <select class="vote-select">
        <option value="">--Choisissez--</option>
        <option value="oui">Oui</option>
        <option value="non">Non</option>
      </select><br>
      <select class="match-result" style="display:none;">
        <option value="">--R√©sultat--</option>
        <option value="equipe1">Victoire Tottenham</option>
        <option value="nul">Nul</option>
        <option value="equipe2">Victoire Slavia Prague</option>
      </select>
    </div>
  </div>

  <button id="submit-btn">Soumettre mes paris</button>
  <div id="your-answer"></div>

  <div id="answersList">
    <h3>üìä Pronostics des autres joueurs :</h3>
    <ul id="answers"></ul>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDDlMXjm5ibq9FiPOjrBD1HFAIlYRnCzqA",
  authDomain: "calendrier2025-3185f.firebaseapp.com",
  projectId: "calendrier2025-3185f",
  storageBucket: "calendrier2025-3185f.firebasestorage.app",
  messagingSenderId: "846792576145",
  appId: "1:846792576145:web:59028ccef4ffd5c8010330",
  measurementId: "G-L62L4JSYMF"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const voteSelects = document.querySelectorAll(".vote-select");
const resultSelects = document.querySelectorAll(".match-result");
const submitBtn = document.getElementById("submit-btn");
const yourAnswerDiv = document.getElementById("your-answer");
const answersListDiv = document.getElementById("answersList");
const answersUl = document.getElementById("answers");
let currentUser = null;

// Affichage conditionnel des r√©sultats
voteSelects.forEach((vs, idx) => {
  vs.addEventListener("change", () => {
    if(vs.value === "oui") resultSelects[idx].style.display = "block";
    else resultSelects[idx].style.display = "none";
  });
});

onAuthStateChanged(auth, async (user) => {
  if(!user) { window.location.href = "login.html"; return; }
  currentUser = user;

  const jour8Ref = doc(db, "Predictions", "Jour 8");
  const jour8Snap = await getDoc(jour8Ref);
  if(jour8Snap.exists() && jour8Snap.data()[user.uid]) {
    showExistingPrediction(jour8Snap.data()[user.uid]);
  } else {
    loadOtherAnswers();
  }
});

function showExistingPrediction(data) {
  voteSelects.forEach(vs => vs.style.display = "none");
  resultSelects.forEach(rs => rs.style.display = "none");
  submitBtn.style.display = "none";

  yourAnswerDiv.innerHTML = "‚úÖ Vos pronostics :<ul style='padding-left:0'>";
  data.predictions.forEach((p,i)=>{
    yourAnswerDiv.innerHTML += `<li>${escapeHtml(p.match)} : ${escapeHtml(p.vote === "oui" ? p.result : "Non vot√©")}</li>`;
  });
  yourAnswerDiv.innerHTML += "</ul>";

  answersListDiv.style.display = "block";
  loadOtherAnswers();
}

submitBtn.addEventListener("click", async ()=>{
  if(!currentUser) { alert("Utilisateur non identifi√©"); return; }

  const predictions = [];
  for(let i=0;i<voteSelects.length;i++){
    predictions.push({
      match: document.querySelectorAll(".match-title")[i].innerText,
      vote: voteSelects[i].value,
      result: resultSelects[i].value
    });
  }

  const payload = {
    userId: currentUser.uid,
    userEmail: currentUser.email,
    predictions,
    timestamp: new Date().toISOString()
  };

  const jour8Ref = doc(db, "Predictions", "Jour 8");
  const jour8Snap = await getDoc(jour8Ref);

  if(jour8Snap.exists()){
    if(jour8Snap.data()[currentUser.uid]){
      alert("Vous avez d√©j√† soumis vos pronostics pour Jour 8.");
      showExistingPrediction(jour8Snap.data()[currentUser.uid]);
      return;
    }
    await updateDoc(jour8Ref, { [currentUser.uid]: payload });
  } else {
    await setDoc(jour8Ref, { [currentUser.uid]: payload });
  }

  showExistingPrediction(payload);
});

async function loadOtherAnswers(){
  answersUl.innerHTML = "";
  const jour8Ref = doc(db, "Predictions", "Jour 8");
  const jour8Snap = await getDoc(jour8Ref);
  if(!jour8Snap.exists()) return;
  const all = jour8Snap.data();
  Object.entries(all).forEach(([uid,data])=>{
    if(uid === currentUser.uid) return;
    const li = document.createElement("li");
    li.innerHTML = `<b>${data.userEmail||'Anonyme'}</b> : ${data.predictions.map(p=>p.vote==='oui'?`${p.match}:${p.result}`:'').filter(Boolean).join(' | ')}`;
    answersUl.appendChild(li);
  });
  answersListDiv.style.display = "block";
}

function escapeHtml(str){
  if(!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}
</script>

</body>
</html>
