<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üéØ Pronostics ‚Äì Jour 4 (Hockey & Euromillions)</title>
  <style>
    body{
      font-family: 'Segoe UI', Tahoma, sans-serif;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      flex-direction:column;
      background-color:#ffebcd;
      background-image:url('https://www.transparenttextures.com/patterns/snow.png');
      margin:0;
      padding:20px;
      gap:18px;
    }
    h1{ font-size:2.2em; color:#b71c1c; font-family:'Comic Sans MS',cursive; text-shadow:2px 2px 5px rgba(0,0,0,0.25); margin:0; text-align:center; width:100%;}
    .container{ width:100%; max-width:920px; margin:0 auto;}
    #userStatus{ position:absolute; top:12px; right:12px; font-size:1.0em; color:#a23636;}
    .panel{
      background:rgba(255,255,255,0.95);
      border-radius:12px;
      padding:18px;
      box-shadow:0 6px 14px rgba(0,0,0,0.12);
      border:2px solid rgba(183,28,28,0.08);
      margin-bottom:18px;
    }
    .panel h2{ margin-top:0; color:#b71c1c; font-size:1.2em;}
    label{ display:block; margin-top:8px; }
    select,input{ padding:10px; font-size:1.02em; margin-top:6px; border-radius:6px; border:1px solid #ccc; width:100%; box-sizing:border-box; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; align-items:start; }
    .small{ font-size:0.9em; color:#666; margin-left:6px; }
    #submit-btn{ padding:12px 20px; font-size:1.05em; cursor:pointer; background-color:#388e3c; color:white; border:none; border-radius:6px; margin-top:12px;}
    #submit-btn:hover{ background-color:#2e7d32; }
    #your-answer{ margin-top:12px; font-weight:bold; font-size:1.02em; color:#2e7d32; }
    #answersList{ display:none; margin-top:18px; padding:12px; border-radius:8px; background:rgba(255,255,255,0.98); box-shadow:0 4px 8px rgba(0,0,0,0.06); }
    #answersList ul{ padding-left:0; margin:0; list-style:none; }
    #answersList li{ background:rgba(250,250,250,0.95); margin:8px 0; padding:10px; border-radius:6px; border-left:5px solid #b71c1c; font-size:0.98em; }
    .validated{ background:#e8fce8; border-left:6px solid #2e7d32; padding:12px; border-radius:8px; }
    .meta{ font-size:0.85em; color:#777; margin-top:6px; }
    .note{ font-size:0.95em; color:#444; margin-top:6px; }
  </style>
</head>
<body>
  <div id="userStatus"></div>

  <div class="container">
    <h1>üéØ Pronostics ‚Äì Jour 4 : Hockey U21 & Euromillions</h1>

    <div class="panel">
      <h2>Indications de points</h2>
      <div class="note">
        <ul style="text-align:left; display:inline-block; margin:6px 0; padding-left:18px;">
          <li><strong>Hockey (par match)</strong> : 2 pts si l'√©quipe qualifi√©e est correcte ; 10 pts si le score exact est correct.</li>
          <li><strong>Euromillions</strong> : bar√®me (affich√©) ‚Äî 5 num + 2 √©toiles = 1000 pts, etc.</li>
        </ul>
      </div>
    </div>

    <!-- HOCKEY -->
    <div class="panel" id="hockey-panel">
      <h2>üèë Hockey sur gazon U21 ‚Äî Devinez le qualifi√© et le score</h2>
      <div class="note small">Remplissez les 4 matchs : choisissez l'√©quipe qui se qualifiera puis indiquez le score (format ex. 2-1).</div>

      <label><b>Espagne - Nouvelle-Z√©lande</b></label>
      <select id="h1-winner">
        <option value="">-- Choisissez --</option>
        <option value="espagne">Espagne</option>
        <option value="nz">Nouvelle-Z√©lande</option>
      </select>
      <input id="h1-score" type="text" placeholder="Score (ex : 2-1)">

      <label><b>France - Allemagne</b></label>
      <select id="h2-winner">
        <option value="">-- Choisissez --</option>
        <option value="france">France</option>
        <option value="allemagne">Allemagne</option>
      </select>
      <input id="h2-score" type="text" placeholder="Score (ex : 1-0)">

      <label><b>Pays-Bas - Argentine</b></label>
      <select id="h3-winner">
        <option value="">-- Choisissez --</option>
        <option value="paysbas">Pays-Bas</option>
        <option value="argentine">Argentine</option>
      </select>
      <input id="h3-score" type="text" placeholder="Score (ex : 3-2)">

      <label><b>Inde - Belgique</b></label>
      <select id="h4-winner">
        <option value="">-- Choisissez --</option>
        <option value="inde">Inde</option>
        <option value="belgique">Belgique</option>
      </select>
      <input id="h4-score" type="text" placeholder="Score (ex : 0-1)">
    </div>

    <!-- EUROMILLIONS -->
    <div class="panel" id="euro-panel">
      <h2>üí´ Euromillions</h2>
      <div class="note small">
        Entrez <strong>5 num√©ros distincts (1‚Äì50)</strong> et <strong>2 √©toiles distinctes (1‚Äì12)</strong>.<br>
        Bar√®me : 5 num + 2 √©toiles = 1000 pts, 5 num + 1 √©toile = 800 pts, 5 num (700 points), 4 num et 2 etoiles (600 points), 4 num et 1 etoile (400 points), 3 num et 2 etoiles (200 points), 4 num (150 points), 2 num et 2 etoiles (120 points), 3 num et 1 etoile (100 points), 3 num (80 points), 1 num et 2 etoiles (60 points), 2 num et 1 etoile (40 pts), 2 num (20 points).
      </div>

      <div class="row">
        <div>
          <label>Num√©ro 1</label>
          <input id="e1" type="number" min="1" max="50" placeholder="1‚Äì50">
        </div>
        <div>
          <label>Num√©ro 2</label>
          <input id="e2" type="number" min="1" max="50" placeholder="1‚Äì50">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Num√©ro 3</label>
          <input id="e3" type="number" min="1" max="50" placeholder="1‚Äì50">
        </div>
        <div>
          <label>Num√©ro 4</label>
          <input id="e4" type="number" min="1" max="50" placeholder="1‚Äì50">
        </div>
      </div>

      <label>Num√©ro 5</label>
      <input id="e5" type="number" min="1" max="50" placeholder="1‚Äì50">

      <div class="row">
        <div>
          <label>√âtoile 1</label>
          <input id="s1" type="number" min="1" max="12" placeholder="1‚Äì12">
        </div>
        <div>
          <label>√âtoile 2</label>
          <input id="s2" type="number" min="1" max="12" placeholder="1‚Äì12">
        </div>
      </div>
    </div>

    <div style="text-align:center; margin-top:6px;">
      <button id="submit-btn">Soumettre mes paris</button>
      <div id="your-answer"></div>
    </div>

    <div id="answersList">
      <h3>üìä Pronostics des autres joueurs :</h3>
      <ul id="answers"></ul>
    </div>

  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDDlMXjm5ibq9FiPOjrBD1HFAIlYRnCzqA",
    authDomain: "calendrier2025-3185f.firebaseapp.com",
    projectId: "calendrier2025-3185f",
    storageBucket: "calendrier2025-3185f.firebasestorage.app",
    messagingSenderId: "846792576145",
    appId: "1:846792576145:web:59028ccef4ffd5c8010330",
    measurementId: "G-L62L4JSYMF"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const submitBtn = document.getElementById('submit-btn');
  const yourAnswerDiv = document.getElementById('your-answer');
  const answersListDiv = document.getElementById('answersList');
  const answersUl = document.getElementById('answers');

  let currentUser = null;

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = 'login.html';
      return;
    }
    currentUser = user;
    document.getElementById('userStatus').innerText = `Connect√© : ${user.email}`;

    // v√©rifier si l'utilisateur a d√©j√† soumis pour Jour 4
    const jourRef = doc(db, 'Predictions', 'Jour 4');
    const snap = await getDoc(jourRef);
    if (snap.exists() && snap.data()[user.uid]) {
      showExistingPrediction(snap.data()[user.uid]);
    } else {
      loadOtherAnswers(); // affiche les autres
    }
  });

  function showExistingPrediction(data) {
    // masquer champs
    document.getElementById('hockey-panel').style.display = 'none';
    document.getElementById('euro-panel').style.display = 'none';
    submitBtn.style.display = 'none';

    // afficher pr√©diction en vert (validated)
    yourAnswerDiv.innerHTML = `
      <div class="validated">
        <h3>‚úÖ Vos pronostics :</h3>
        <div style="text-align:left;">
          <strong>Hockey</strong>
          <ul>
            <li>Espagne - NZ : ${escapeHtml(data.h1Winner || '')} ‚Äî ${escapeHtml(data.h1Score || '')}</li>
            <li>France - All : ${escapeHtml(data.h2Winner || '')} ‚Äî ${escapeHtml(data.h2Score || '')}</li>
            <li>Pays-Bas - Arg : ${escapeHtml(data.h3Winner || '')} ‚Äî ${escapeHtml(data.h3Score || '')}</li>
            <li>Inde - Bel : ${escapeHtml(data.h4Winner || '')} ‚Äî ${escapeHtml(data.h4Score || '')}</li>
          </ul>
          <strong>Euromillions</strong>
          <div>Num√©ros : ${Array.isArray(data.euroNums) ? data.euroNums.join(', ') : ''}</div>
          <div>√âtoiles : ${Array.isArray(data.euroStars) ? data.euroStars.join(', ') : ''}</div>
          <div class="meta">Soumis le : ${escapeHtml(new Date(data.timestamp || '').toLocaleString() || '')}</div>
        </div>
      </div>
    `;
    answersListDiv.style.display = 'block';
    loadOtherAnswers();
  }

  // validate Euromillions numbers: 5 distinct 1-50, 2 distinct 1-12
  function validateEuro(nums, stars) {
    if (nums.length !==5 || stars.length !==2) return false;
    const numsSet = new Set(nums.map(n=>Number(n)));
    const starsSet = new Set(stars.map(s=>Number(s)));
    if (numsSet.size !== 5 || starsSet.size !== 2) return false;
    for (const n of numsSet) if (isNaN(n) || n < 1 || n > 50) return false;
    for (const s of starsSet) if (isNaN(s) || s < 1 || s > 12) return false;
    return true;
  }

  submitBtn.addEventListener('click', async () => {
    // read hockey
    const h1Winner = document.getElementById('h1-winner').value;
    const h1Score  = document.getElementById('h1-score').value.trim();
    const h2Winner = document.getElementById('h2-winner').value;
    const h2Score  = document.getElementById('h2-score').value.trim();
    const h3Winner = document.getElementById('h3-winner').value;
    const h3Score  = document.getElementById('h3-score').value.trim();
    const h4Winner = document.getElementById('h4-winner').value;
    const h4Score  = document.getElementById('h4-score').value.trim();

    if (!h1Winner || !h1Score || !h2Winner || !h2Score || !h3Winner || !h3Score || !h4Winner || !h4Score) {
      alert('Merci de remplir toutes les pr√©visions de hockey (qualifi√© + score).');
      return;
    }

    // Euromillions
    const e1 = document.getElementById('e1').value;
    const e2 = document.getElementById('e2').value;
    const e3 = document.getElementById('e3').value;
    const e4 = document.getElementById('e4').value;
    const e5 = document.getElementById('e5').value;
    const s1 = document.getElementById('s1').value;
    const s2 = document.getElementById('s2').value;

    const nums = [e1,e2,e3,e4,e5].map(v=>v===''?NaN:Number(v));
    const stars = [s1,s2].map(v=>v===''?NaN:Number(v));

    if (!validateEuro(nums, stars)) {
      alert('Euromillions : entrez 5 num√©ros distincts (1‚Äì50) et 2 √©toiles distinctes (1‚Äì12).');
      return;
    }

    // build payload
    const jourRef = doc(db, 'Predictions', 'Jour 4');
    const snap = await getDoc(jourRef);

    const payload = {
      h1Winner, h1Score,
      h2Winner, h2Score,
      h3Winner, h3Score,
      h4Winner, h4Score,
      euroNums: nums.map(n=>Number(n)),
      euroStars: stars.map(s=>Number(s)),
      email: currentUser.email,
      timestamp: new Date().toISOString()
    };

    if (snap.exists()) {
      const data = snap.data();
      if (data[currentUser.uid]) {
        alert('Vous avez d√©j√† soumis vos paris pour Jour 4.');
        return;
      }
      await updateDoc(jourRef, { [currentUser.uid]: payload });
    } else {
      await setDoc(jourRef, { [currentUser.uid]: payload });
    }

    showExistingPrediction(payload);
  });

  // load others
  async function loadOtherAnswers() {
    answersUl.innerHTML = '';
    const jourRef = doc(db, 'Predictions', 'Jour 4');
    const snap = await getDoc(jourRef);
    if (!snap.exists()) {
      answersUl.innerHTML = '<li class="small">Aucune r√©ponse pour l‚Äôinstant.</li>';
      answersListDiv.style.display = 'block';
      return;
    }

    const all = snap.data();
    const entries = Object.entries(all).filter(([uid]) => uid !== (currentUser && currentUser.uid));
    if (entries.length === 0) {
      answersUl.innerHTML = '<li class="small">Aucune autre r√©ponse pour l‚Äôinstant.</li>';
      answersListDiv.style.display = 'block';
      return;
    }

    // sort by timestamp desc (if present)
    entries.sort((a,b) => {
      const ta = a[1].timestamp ? Date.parse(a[1].timestamp) : 0;
      const tb = b[1].timestamp ? Date.parse(b[1].timestamp) : 0;
      return tb - ta;
    });

    for (const [uid, p] of entries) {
      const li = document.createElement('li');
      li.innerHTML = `
        <strong>${escapeHtml(p.email || 'Anonyme')}</strong> ‚Äî
        <div style="margin-top:6px;">
          <em>Hockey</em> : Esp-NZ ${escapeHtml(p.h1Winner||'')} (${escapeHtml(p.h1Score||'')}) |
          Fr-All ${escapeHtml(p.h2Winner||'')} (${escapeHtml(p.h2Score||'')}) |
          PB-Arg ${escapeHtml(p.h3Winner||'')} (${escapeHtml(p.h3Score||'')}) |
          Inde-Bel ${escapeHtml(p.h4Winner||'')} (${escapeHtml(p.h4Score||'')})
        </div>
        <div style="margin-top:6px;">
          <em>Euromillions</em> : ${Array.isArray(p.euroNums)?p.euroNums.join(', '):''} ‚Äî
          √©toiles: ${Array.isArray(p.euroStars)?p.euroStars.join(', '):''}
        </div>
        <div class="meta">${escapeHtml(new Date(p.timestamp||'').toLocaleString()||'')}</div>
      `;
      answersUl.appendChild(li);
    }
    answersListDiv.style.display = 'block';
  }

  function escapeHtml(str) {
    if (str === undefined || str === null) return '';
    return String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

</script>
</body>
</html>
