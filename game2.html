<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéØ Pronostics ‚Äì Jour 2</title>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #ffebcd;
      background-image: url('https://www.transparenttextures.com/patterns/snow.png');
      margin: 0;
      padding: 20px;
    }

    h1 {
      font-size: 2.3em;
      margin-bottom: 10px;
      color: #b71c1c;
      font-family: 'Comic Sans MS', cursive;
      text-shadow: 2px 2px 5px rgba(0,0,0,0.3);
    }

    #userStatus {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 1.1em;
      color: #a23636;
    }

    #instructions {
      background: rgba(255,255,255,0.9);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      margin-bottom: 20px;
      max-width: 900px;
      font-size: 1.1em;
      text-align: center;
    }

    .block {
      background: rgba(255,255,255,0.85);
      border: 2px solid #b71c1c;
      border-radius: 12px;
      padding: 20px;
      width: 90%;
      max-width: 520px;
      margin-bottom: 25px;
      box-shadow: 0 8px 12px rgba(0,0,0,0.2);
    }

    select, input {
      width: 85%;
      padding: 10px;
      margin: 8px 0;
      font-size: 1.1em;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    #submit-btn {
      padding: 12px 20px;
      font-size: 1.2em;
      background-color: #388e3c;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
    }
    #submit-btn:hover { background-color: #2e7d32; }

    #your-answer {
      font-weight: bold;
      margin-top: 10px;
      font-size: 1.2em;
      color: #2e7d32;
    }

    #answersList {
      display: none;
      background: rgba(255,255,255,0.92);
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 650px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.25);
      margin-top: 25px;
    }

    #answersList li {
      background: rgba(255,255,255,0.6);
      border-left: 5px solid #b71c1c;
      padding: 6px 10px;
      margin: 6px 0;
      border-radius: 6px;
      list-style: none;
    }

    .validated {
      background: #e8fce8 !important;
      border-left: 6px solid #2e7d32 !important;
    }
  </style>
</head>

<body>
<h1>üèÜ Pronostics ‚Äì Jour 2</h1>
<div id="userStatus"></div>

<div id="instructions">
  <p><b>Handball f√©minin :</b> Choisissez le r√©sultat des 6 matchs (3 pts par bonne r√©ponse)</p>
  <p><b>Biathlon ‚Äì 20 km hommes :</b> Trouvez le gagnant (15 pts) et sa nationalit√© (10 pts)</p>
  <p><b>Metroid Prime 4 :</b> Note Metacritic public (10 pts, -1 par √©cart)</p>
</div>

<!-- ===================== HAND ======= -->
<div class="block">
  <h2>ü§æ Handball ‚Äì 6 matchs</h2>

  <div id="handballArea">
    <label>Danemark ‚Äì S√©n√©gal</label><br>
    <select id="m1">
      <option value="">-- Choisissez --</option>
      <option value="danemark">Danemark</option>
      <option value="nul">Nul</option>
      <option value="senegal">S√©n√©gal</option>
    </select><br>

    <label>Hongrie ‚Äì Roumanie</label><br>
    <select id="m2">
      <option value="">-- Choisissez --</option>
      <option value="hongrie">Hongrie</option>
      <option value="nul">Nul</option>
      <option value="roumanie">Roumanie</option>
    </select><br>

    <label>Japon ‚Äì Suisse</label><br>
    <select id="m3">
      <option value="">-- Choisissez --</option>
      <option value="japon">Japon</option>
      <option value="nul">Nul</option>
      <option value="suisse">Suisse</option>
    </select><br>

    <label>Br√©sil ‚Äì Cor√©e du Sud</label><br>
    <select id="m4">
      <option value="">-- Choisissez --</option>
      <option value="bresil">Br√©sil</option>
      <option value="nul">Nul</option>
      <option value="coree">Cor√©e du Sud</option>
    </select><br>

    <label>Norv√®ge ‚Äì Su√®de</label><br>
    <select id="m5">
      <option value="">-- Choisissez --</option>
      <option value="norvege">Norv√®ge</option>
      <option value="nul">Nul</option>
      <option value="suede">Su√®de</option>
    </select><br>

    <label>Angola ‚Äì Tch√©quie</label><br>
    <select id="m6">
      <option value="">-- Choisissez --</option>
      <option value="angola">Angola</option>
      <option value="nul">Nul</option>
      <option value="tchequie">Tch√©quie</option>
    </select><br>
  </div>
</div>

<!-- ===================== BIATHLON ======= -->
<div class="block">
  <h2>üéø Biathlon ‚Äì 20 km hommes</h2>

  <label>Choisissez le gagnant :</label><br>
  <select id="biathlonWinner">
    <option value="">-- Choisissez --</option>
    <option value="Uldal">Uldal</option>
    <option value="Frey">Frey</option>
    <option value="Christiansen">Christiansen</option>
    <option value="Samuelsson">Samuelsson</option>
    <option value="Nelin">Nelin</option>
    <option value="Perrot">Perrot</option>
    <option value="Jacquelin">Jacquelin</option>
    <option value="Fillon-Maillet">Fillon Maillet</option>
    <option value="Autre">Autre</option>
  </select><br>

  <label>Nationalit√© du gagnant :</label><br>
  <input id="biathlonNat" type="text" placeholder="ex : Norv√®ge"><br>
</div>

<!-- ===================== METACRITIC ======= -->
<div class="block">
  <h2>üéÆ Metroid Prime 4</h2>
  <label>Note du public Metacritic (0-100)</label><br>
  <input id="metaNote" type="number" min="0" max="100" placeholder="ex : 87">
</div>

<!-- SUBMIT -->
<button id="submit-btn">Soumettre mes pronostics</button>
<div id="your-answer"></div>

<!-- OTHER ANSWERS -->
<div id="answersList">
  <h3>üìä Pronostics des autres joueurs :</h3>
  <ul id="answers"></ul>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDDlMXjm5ibq9FiPOjrBD1HFAIlYRnCzqA",
  authDomain: "calendrier2025-3185f.firebaseapp.com",
  projectId: "calendrier2025-3185f",
  storageBucket: "calendrier2025-3185f.firebasestorage.app",
  messagingSenderId: "846792576145",
  appId: "1:846792576145:web:59028ccef4ffd5c8010330",
  measurementId: "G-L62L4JSYMF"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;

onAuthStateChanged(auth, async (user) => {
  if (!user) return window.location.href = "login.html";

  currentUser = user;
  document.getElementById("userStatus").innerText = `Connect√© : ${user.email}`;

  const ref = doc(db, "Predictions", "Jour 2");
  const snap = await getDoc(ref);

  if (snap.exists() && snap.data()[user.uid]) {
    showExistingPrediction(snap.data()[user.uid]);
  }
});

function showExistingPrediction(data) {
  document.getElementById("handballArea").style.display = "none";
  document.getElementById("biathlonWinner").style.display = "none";
  document.getElementById("biathlonNat").style.display = "none";
  document.getElementById("metaNote").style.display = "none";
  document.getElementById("submit-btn").style.display = "none";

  const div = document.getElementById("your-answer");

  div.innerHTML = `
    <div class="validated">
      <h3>‚úÖ Vos pronostics :</h3>
      <b>Handball :</b> ${JSON.stringify(data.handball)}<br>
      <b>Biathlon :</b> ${data.biathlonWinner} (${data.biathlonNat})<br>
      <b>Metacritic :</b> ${data.meta}
    </div>
  `;

  document.getElementById("answersList").style.display = "block";
  loadOtherAnswers();
}

document.getElementById("submit-btn").addEventListener("click", async () => {
  const m1 = m1.value, m2 = m2.value, m3 = m3.value, m4 = m4.value, m5 = m5.value, m6 = m6.value;
  const biathlonWinner = document.getElementById("biathlonWinner").value;
  const biathlonNat = document.getElementById("biathlonNat").value.trim();
  const metaNote = document.getElementById("metaNote").value.trim();

  if (!m1 || !m2 || !m3 || !m4 || !m5 || !m6 ||
      !biathlonWinner || !biathlonNat || !metaNote) {
    return alert("Merci de remplir tous les champs !");
  }

  const ref = doc(db, "Predictions", "Jour 2");
  const snap = await getDoc(ref);

  const predictions = {
    handball: { m1, m2, m3, m4, m5, m6 },
    biathlonWinner,
    biathlonNat,
    meta: parseInt(metaNote),
    email: currentUser.email,
    timestamp: new Date()
  };

  if (snap.exists()) {
    if (snap.data()[currentUser.uid]) return alert("Vous avez d√©j√† vot√© !");
    await updateDoc(ref, { [currentUser.uid]: predictions });
  } else {
    await setDoc(ref, { [currentUser.uid]: predictions });
  }

  showExistingPrediction(predictions);
});

async function loadOtherAnswers() {
  const answersList = document.getElementById("answers");
  answersList.innerHTML = "";

  const ref = doc(db, "Predictions", "Jour 2");
  const snap = await getDoc(ref);
  if (!snap.exists()) return;

  const data = snap.data();
  for (const uid in data) {
    if (uid === currentUser.uid) continue;

    const p = data[uid];
    const li = document.createElement("li");
    li.innerHTML = `
      <b>${p.email || "Anonyme"}</b> ‚Üí 
      Handball: ${JSON.stringify(p.handball)} |
      Biathlon : ${p.biathlonWinner} |
      Meta : ${p.meta}
    `;
    answersList.appendChild(li);
  }
}
</script>
</body>
</html>
